# リファクタリング評価と優先順位 (Refactoring Assessment)

## 概要
`search-for-medicine` プロジェクト全体の現状調査に基づき、リファクタリングの必要性を評価・提案します。
最大の課題は「AIロジックの分散」と「ビルド/開発環境の断絶」にあり、これらを解決することで保守性と開発効率が大幅に向上します。

## 優先順位サマリー

| 優先度 | 項目 | 影響範囲 | 推定工数 | 理由 |
| :--- | :--- | :--- | :--- | :--- |
| **高** | **AIロジックの統合と共通化** | 全体 | 大 | モデル更新やプロンプト管理が分散しており、不整合のリスクが高い。 |
| **高** | **残存課題の解決と整理** | ルート | 小 | GAタグ未導入など、計画されていたが未完のタスクが存在。 |
| **中** | **ワークスペース導入によるビルド改善** | 全体 | 中 | 依存関係のインストール待ち時間が長く、ディスク使用量も無駄が多い。 |
| **低** | **共通UIコンポーネント化** | 全体 | 大 | ヘッダー/フッターの重複。技術スタック混在(Vite/Next.js)のため難易度高。 |
| **低** | **Vanilla JSアプリのモダン化** | Recipe App | 中 | 現状動作しているため急務ではない。 |

---

## 詳細評価

### 1. AIロジックの統合と共通化 (優先度: 高)
**現状:**
- `recipe-app`: Cloudflare Worker (`recipe-worker`) を使用。
- `drug-navigator`: Next.js API Routes (`src/app/api/...`) を使用。
- `okuri_pakkun`: おそらく Next.js API Routes を使用。
- それぞれで OpenAI / Gemini クライアントの初期化、APIキー管理、プロンプト定義が行われている。

**問題点:**
- AIモデル（例: `gemini-3-flash`）を一斉にアップデートしたい場合、全箇所を修正する必要がある。
- プロンプトの品質管理や、エラーハンドリング（レート制限など）の方針が統一されていない。
- 型定義（Response型など）が共有されていない。

**提案:**
- **短期的:** `packages/ai-core` のようなディレクトリを作成し、AIクライアントの生成ロジックと型定義を共有する（npm workspacesが必要）。
- **長期的:** 単一の「AI Gateway」サービス（Next.js API または Worker）を作成し、全フロントエンドアプリからそこへリクエストを送る形に統一する。

### 2. 残存課題の解決と整理 (優先度: 高)
**現状:**
- `RENEWAL_PLAN.md` に記載された「GAタグ導入」が `index.html` や各サブページに反映されていない可能性が高い。
- `index_v1_backup.html` や `TODO.md` (okuri_pakkun内) など、古い状態を示すファイルが散在している。

**問題点:**
- 計測漏れにより、ユーザー行動の分析ができない。
- 新規開発者がプロジェクトに参加した際、どのドキュメントが最新か混乱する。

**提案:**
- GAタグ (`G-VXSZGE4HP7`) を全対象ページに実装する。
- 完了した計画書や古いバックアップファイルを `docs/archive` に移動するか削除する。

### 3. ビルド・開発環境の適正化 (優先度: 中)
**現状:**
- `build.js` が各ディレクトリで `npm install && npm run build` を順次実行している。
- ルートの `package.json` にワークスペース定義がない。

**問題点:**
- ビルド時間が長い（依存関係の解決が何度も走る）。
- 開発時、ルートの `vite` だけでは Next.js アプリ (`drug-navigator`, `okuri_pakkun`) が起動せず、個別にターミナルを開いて起動する必要がある。

**提案:**
- **npm workspaces** (または pnpm) を導入し、依存関係をルート引き上げで一元管理する。
- `concurrently` を導入し、`npm run dev` 一発で全アプリの開発サーバーを起動・プロキシ接続できるようにする。

### 4. 共通UIコンポーネント化 (優先度: 低)
**現状:**
- ヘッダーやフッターのHTML/CSSが、Viteアプリ（静的HTML + Web Components?）と Next.js アプリでそれぞれ実装されている。

**問題点:**
- メニュー項目の追加変更時に、全てのアプリを修正する必要がある。

**提案:**
- 技術スタックが混在しているため、**Web Components** (Custom Elements) としてヘッダー/フッターを実装し、Next.js アプリからもそれを読み込んで使用するように統一する。

---

## 推奨ロードマップ

1. **フェーズ1: クリーンアップ (今すぐ実施)**
   - GAタグの導入完了。
   - 不要ファイルの整理。
   - `build.js` の小規模修正（もしあれば）。

2. **フェーズ2: 開発環境の整備**
   - npm workspaces の導入。
   - `concurrently` による一括起動設定。

3. **フェーズ3: AI基盤の統合**
   - 共通AIモジュールの作成。
   - 各アプリからの移行。
