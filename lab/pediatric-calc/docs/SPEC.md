# 小児用量計算アプリ (Pediatric Calc) 仕様書

## 1. 概要 (Overview)
本アプリケーションは、小児薬用量の計算を支援するためのWebツールである。
薬剤師や医師が処方監査や処方設計を行う際に、患児の年齢・体重に基づき、添付文書に記載された用法用量を即座に算出・確認することを目的とする。

### 1.1 背景
当初は小児服薬支援アプリ「おくすりぱっくん」の補助機能として開発が検討されたが、以下の理由により独立したアプリケーションとして実装された。
*   「味」の情報は製剤（メーカー）ごとに異なるが、用法用量は基本的に「成分」単位で決まるため、データ構造が異なる。
*   服薬支援（患者向け）と用量計算（医療従事者向け）ではターゲットユーザーとユースケースが異なる。

## 2. 機能要件 (Functional Requirements)

### 2.1 入力機能
*   **年齢入力**: 歳・ヶ月単位で入力可能。
*   **体重入力**: kg単位で入力可能 (小数点対応)。
*   **標準体重自動入力**: 年齢から標準的な体重を推計し、自動入力する機能を持つ。

### 2.2 薬剤選択機能
*   **検索欄なし**: テキスト検索ではなく、薬効分類（抗生剤、抗ウイルス、呼吸器など）によるタブ切り替えとグリッド表示を採用。
*   **複数選択**: 複数の薬剤を同時に選択し、リスト化して比較・計算が可能。
*   **パーソナライズ (Local Storage保存)**:
    *   選択した薬剤の状態（Selected Drugs）はブラウザのLocalStorageに自動保存される。
    *   次回起動時も前回の選択状態が維持されるため、頻繁に処方する薬剤を選択したままにしておくことで、ユーザー独自の「My医薬品集」として機能する。
*   **規格選択**: 同一成分で規格違い（例：10%細粒と20%細粒）がある場合、選択時に指定可能。

### 2.3 計算・表示機能
*   **リアルタイム計算**: 入力された体重に基づき、1日量、1回量などを即座に再計算する。
*   **用量チェック**:
    *   計算結果が添付文書の推奨範囲（mg/kg/日）内か判定。
    *   上限チェック：1日最大量（成分または成人量）や1回最大量を超えていないか確認。
*   **特殊計算ロジック対応**:
    *   **通常計算**: 体重 × mg/kg = 1日量。
    *   **体重別固定量**: 体重区分ごとの固定用量（例：ゾフルーザ）。
    *   **年齢別固定量**: 年齢区分ごとの固定用量（例：イナビル）。
    *   **疾患別用量**: 適応症（例：水痘 vs 単純ヘルペス）による用量切り替えに対応。
*   **添付文書参照**: 各薬剤のカードまたはリストから、PMDAの添付文書ページへ直接リンク。

## 3. UI/UX デザイン仕様

### 3.1 コンセプト
*   **モバイル・タブレットファースト**: 狭い画面でも情報一覧性を確保するため、無駄な余白を排除。
*   **横スクロール処方シート**: 
    selected drugs（処方シート）は画面上部（または下部）に配置し、横スクロールで複数の計算結果を並列に確認できるUIを採用。
*   **カテゴリータブ**: 頻用される薬効分類をタブで切り替え、視覚的に素早く目的の薬剤にアクセス可能。

## 4. データ構造 (Data Model)
薬剤データは `calc.js` 内の `PEDIATRIC_DRUGS` 配列で管理される。

### 4.1 薬剤オブジェクト構造
```javascript
{
  id: string,               // 一意のID
  name: string,             // 表示名
  brandName: string,        // 先発品名など
  yjCode: string,           // YJコード (代表コード)
  piUrl: string,            // PMDA添付文書URL
  potency: number,          // 力価または製剤量 (例: 100mg/g = 10%)
  
  // 計算ロジック定義
  dosage: {
    minMgKg: number,        // 最小用量 (mg/kg/day)
    maxMgKg: number,        // 最大用量 (mg/kg/day)
    timesPerDay: number,    // 分服回数
    absoluteMaxMgPerDay: number, // 1日最大量 (mg) - 成人量など
    isByTime: boolean,      // 1回量基準の場合はtrue (例: アセトアミノフェン)
    timeMgKg: number,       // 1回あたりの用量 (mg/kg/dose)
    // その他、年齢/体重による分岐ロジックを含む
  },
  
  // 疾患別用量 (Optional)
  diseases: [
    { id, label, dosage: { ... } }
  ],
  
  // 規格違い (Optional)
  subOptions: [
    { id, label, potency }
  ]
}
```

## 5. ロードマップ (Future Work)
*   **機能拡張**:
    *   シロップ剤の追加対応。
    *   医薬品供給状況（Supply Status）との連携表示。
    *   味情報（おくすりぱっくんデータ）の表示連携。
*   **UX改善**:
    *   医薬品集としての利便性向上のための、ドラッグ＆ドロップまたは設定画面による「薬剤並び替え」機能（LocalStorage利用の検討）。

## 6. 技術スタック (Tech Stack)
*   **Frontend**: Vanilla JavaScript (ES Modules), HTML5, CSS3
*   **Design**: Custom CSS (Variables, Grid/Flexbox), FontAwesome (Icons)
*   **Data Source**: PMDA添付文書に基づく手動整備データ

## 6. 特記事項・制約
*   **データ精度**: AIによる自動生成データの誤りが多発したため、全データを目視および添付文書との突合により検証済み。
*   **免責事項**: 本アプリは計算補助ツールであり、最終的な投与量の判断は医師・薬剤師の責任において行うものとする。
